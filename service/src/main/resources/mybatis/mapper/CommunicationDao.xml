<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scrm.service.dao.CommunicationDao">
    <select id="queryCommunication" resultType="com.scrm.service.entity.UserAndCommunication">
        <bind name="key_offset" value="(currentPage-1)*pageCount"/>
        select se_customer.id, se_customer.customer_name, se_customer.customer_type, se_customer.telephone, se_customer.belong_company, se_customer.customer_icon, se_label.label_name, se_customer.enter_pool_date
        from se_customer
        left join se_customer_label_relation on se_customer.id = se_customer_label_relation.customer_id
        left join se_label on se_customer_label_relation.label_id = se_label.id
        <if test="pageCount != null and currentPage != null">
            limit #{key_offset},#{pageCount}
        </if>
    </select>

    <select id="queryCommunicationByKey" resultType="com.scrm.service.entity.UserAndCommunication">
        select se_customer.id, se_customer.customer_name, se_customer.customer_type, se_customer.telephone, se_customer.belong_company, se_customer.customer_icon, se_label.label_name, se_customer.enter_pool_date
        from se_customer
        left join se_customer_label_relation on se_customer.id = se_customer_label_relation.customer_id
        left join se_label on se_customer_label_relation.label_id = se_label.id
        where se_customer.customer_name like "%"#{customerName}"%"
    </select>

    <select id="queryCount" resultType="Integer">
        select count(id) from se_customer
    </select>

    <insert id="addCommunication" parameterType="com.scrm.service.entity.Communication"
            keyProperty="id" useGeneratedKeys="true">
        insert into se_communication (customer_id)
        values(#{customerId})
    </insert>

    <update id="editCommunication" parameterType="com.scrm.service.entity.Communication">
        update se_communication set customer_id = #{customerId}, visit_times = #{visitTimes}, call_times = #{callTimes}, msg_times = #{msgTimes}, wx_times = #{wxTimes}
        where id = #{id}
    </update>

    <delete id="deleteCommunication">
        delete from se_communication where customer_id = #{customerId}
    </delete>

    <delete id="deleteCommunicationLog">
        delete from se_communication_log where customer_id = #{customerId}
    </delete>
</mapper>