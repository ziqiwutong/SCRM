<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scrm.service.dao.OrderAndOrderDetailDao">
    <resultMap id="cor1" type="java.util.LinkedHashMap">
        <result property="productName" column="product_name" />
        <result property="orderType" column="pay_flag" />
        <result property="productPrice" column="product_price" />
        <result property="orderBuyer" column="customer_name" />
        <result property="orderStaff" column="order_staff" />
        <result property="productPic" column="product_image" />
        <result property="orderID" column="order_num" />
        <result property="productBuyAmount" column="product_amount" />
        <result property="notes" column="order_notes" />
        <result property="orderSource" column="order_source" />
        <result property="orderTime" column="create_time"/>
        <result property="orderFinish" column="pay_time" />
        <result property="priceChange" column="change_price" />
    </resultMap>

    <select id="queryOrderAndOrderDetail" resultMap="cor1">
        select `product_name` , `pay_flag`, `product_price`, `customer_name`, `order_staff`,
        `product_image`, `order_num`, `product_amount`, `order_notes`, `order_source`,
        d.`create_time`, `pay_time`,`change_price`
        from se_order,se_order_detail as d
        where order_id=se_order.id and order_num=#{orderId}
    </select>
<!--limit #{key_offset},#{pageCount}-->
    <select id="queryOrder" resultMap="cor1">
        select `product_name` , `pay_flag`, `product_price`,
        `product_amount`, `customer_name`, `product_image`, `order_num`
        from se_order,se_order_detail as d
        where order_id=se_order.id
        <if test="orderType==1">
            and `pay_flag`=0
        </if>
        <if test="orderType==2">
            and `success_flag`=1
        </if>
        order by se_order.id asc
        <if test="pageNum != null and pageSize != null">
            limit ${(pageNum-1)*pageSize},#{pageSize}
        </if>
    </select>

    <select id="queryCount" resultType="Integer">
        select count(id) from se_order
    </select>

    <select id="queryOrderByKey" resultMap="cor1">
        select `product_name` , `pay_flag`, `product_price`,
        `product_amount`, `customer_name`, `product_image`, `order_num`
        from se_order,se_order_detail as d
        where order_id=se_order.id
        <if test="orderType==1">
            and `pay_flag`=0
        </if>
        <if test="orderType==2">
            and `success_flag`=1
        </if>
        <if test="keySearch != null">
        and product_name like "%" #{keySearch} "%"
        </if>
        order by se_order.id asc
    </select>

    <delete id="deleteOrder">
        delete from se_order where order_num = #{orderID}
    </delete>

    <delete id="deleteOrderWith">
        delete from se_order_detail where order_id=(select id from se_order where order_num=#{orderID})
    </delete>

    <insert id="addOrder" parameterType="com.scrm.service.entity.OrderAndOrderDetail"
            keyProperty="id" useGeneratedKeys="true">
        insert into se_order(pay_flag,order_staff,success_flag)
        values(#{payFlag}, #{orderStaff}, #{payFlag})
    </insert>

    <insert id="addOrderWith" parameterType="com.scrm.service.entity.OrderAndOrderDetail"
            keyProperty="id" useGeneratedKeys="true">
        insert into se_order_detail(order_id, order_notes, product_name, product_price,
        product_amount, customer_name,product_image,order_source, change_price)
        values((select id from se_order order by id desc limit 1), #{orderNotes},
        #{productName}, #{productPrice}, #{productAmount}, #{customerName},
        #{productImage}, #{orderSource}, #{changePrice})
    </insert>

    <update id="editOrder" parameterType="com.scrm.service.entity.OrderAndOrderDetail">
        update se_order set id=id
        <if test="payFlag != null">
            ,pay_flag=#{payFlag}, success_flag=#{payFlag}
        </if>
        <if test="orderStaff != null">
            ,order_staff=#{orderStaff}
        </if>
        where order_num = #{orderNum}
    </update>

    <update id="editOrderWith" parameterType="com.scrm.service.entity.OrderAndOrderDetail">
        update se_order_detail set id=id
        <if test="orderNotes!=null">
            ,order_notes=#{orderNotes}
        </if>
        <if test="productName!=null">
            ,product_name=#{productName}
        </if>
        <if test="productPrice!=null">
            ,product_price=#{productPrice}
        </if>
        <if test="productAmount!=null">
            ,product_amount=#{productAmount}
        </if>
        <if test="customerName">
            ,customer_name=#{customerName}
        </if>
        <if test="productImage">
            ,product_image=#{productImage}
        </if>
        <if test="orderSource">
            ,order_source=#{orderSource}
        </if>
        <if test="changePrice">
            ,change_price=#{changePrice}
        </if>
        where order_id=(select id from se_order where order_num=#{orderNum})
    </update>

</mapper>